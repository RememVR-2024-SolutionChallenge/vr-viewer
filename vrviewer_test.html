<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()" />
    <title>3D Gaussian Splat Demo - Interactive Transformation</title>
    <script type="importmap">
      {
        "imports": {
          "three": "./lib/three.module.js",
          "@mkkellogg/gaussian-splats-3d": "./lib/gaussian-splats-3d.module.js",
          "FBXLoader": "./js/FBXLoader.js"
        }
      }
    </script>
    <style>
      body {
        background-color: #000000;
        color: white;
        height: 100vh;
        margin: 0px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import * as THREE from "three";
      import * as GaussianSplats3D from "@mkkellogg/gaussian-splats-3d";
      import { FBXLoader } from "FBXLoader";

      const TYPE = {
        metadata: "metadata",
        scenePosition: "scenePosition",
        avatarPosition: "avatarPosition",
        scene: "scene",
        avatar: "avatar",
      };

      /* -------------------------- Modules And Utilties -------------------------- */
      var metadata = null;
      //   var scenePosition = null;
      //   var avatarsPosition = [];
      var sceneUrl = null;
      var avatarsUrl = [];
      var avatarsPath = [
        "https://storage.googleapis.com/3dgs-storage/sample/sample-avatar-1/model.fbx?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=gmail-431%40rememberme-2024.iam.gserviceaccount.com%2F20240516%2Fauto%2Fstorage%2Fgoog4_request&X-Goog-Date=20240516T173448Z&X-Goog-Expires=600&X-Goog-SignedHeaders=host&X-Goog-Signature=8567d7793c8882feb77f7bdbcd833800a17dc0ece6499e4ee72a6d2868daeefcba457577638d8111a661ca8e832b4ed73a35d0037199746d83e3b9834c36263778e25a2d763faa816228109a6fa016b70cda98ba635c61e423635f1e7345b31cb48374127d59aef87979d56e72ba3597d461cb06f64334ae247bf37cf67a313856a129e8e6a67b90812fe7f8024f8b74cc777fbc190dcafa0ea68659bda72776e656034879f2df3574bc3ad5443cc660fb5a83f2c4d0da4d9043b9cf6eec0eee5cbe9bf03d7fc777d12b54468dff4bdcbc547a82a87a8f979b7250228ddee13df47054b6cff1070e177cc3be93c69af31f6399e966ccab1f3f32de86b65e6555",
      ];
      var scenePath =
        "https://storage.googleapis.com/3dgs-storage/sample/sample-scene-10?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=gmail-431%40rememberme-2024.iam.gserviceaccount.com%2F20240516%2Fauto%2Fstorage%2Fgoog4_request&X-Goog-Date=20240516T173447Z&X-Goog-Expires=600&X-Goog-SignedHeaders=host&X-Goog-Signature=61d44aa054c9dc64f4d6ed219acbfd3077087e569f9b7364c773f64db365dbf51a9d43d7e45ee46fbe8ca2ab4c25bffd4e8a63adf1e41ab99787cef32f33d546c8a630f005844621a7d888b0e5dce19f93642d862426952acb4e2cf59abd7460c4b4ab63e1b75ccd682d55fd34f547d0bff8d89db9f68011335ff4c9a58a7c5a9643fa3f1818ff102cd07e447f358286c768e8e8915558f428c05c2dc694a7fe6f56fd56c9efd25cfc2badb43b2774e81e2b207f9e0e2c5efdd67003276e2795fc0cd7fea5b3446ba268c4fdc08c13e75d91c84e99278081f6197cabd769b4e70e55ba66eed9456cbf22ec27161ef7c6679281266445f4387b2ff6c489ac4d66";
      async function main() {
        const viewer = new GaussianSplats3D.Viewer({
          cameraUp: [-0.16412, 0.00561, 0.98642],
          initialCameraPosition: [-1.00417, 0.06068, 0.07115],
          initialCameraLookAt: [0.66885, 0.03159, -0.20574],
          webXRMode: GaussianSplats3D.WebXRMode.VR,
        });

        const threeScene = new THREE.Scene();
        const loader = new FBXLoader();
        let fbxObject;
        let mixer;
        const clock = new THREE.Clock();

        for (let i = 0; i < avatarsPath.length; i++) {
          const model = await new Promise((resolve, reject) => {
            loader.load(avatarsPath[i], resolve, undefined, reject);
          });
          model.position.set(0, 0, 0);
          model.scale.set(0, 0, 0);
          model.quaternion.copy(new THREE.Quaternion(0, 0, 0, 0));
          threeScene.add(model);
          fbxObject = model;
          mixer = new THREE.AnimationMixer(model);
          viewer.threeScene = threeScene;
          console.log("FBX Model loaded and added to the scene.");
        }

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        threeScene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(0, 1, 0);
        threeScene.add(directionalLight);
        // Fetch the scene first to ensure it's available
        try {
          const response = await fetch(scenePath);
          if (!response.ok) {
            throw new Error(`Failed to load scene from ${scenePath}`);
          }
          const sceneData = await response.arrayBuffer();

          // Create a blob from the ArrayBuffer and generate a URL for it
          const blob = new Blob([sceneData]);
          const blobUrl = URL.createObjectURL(blob);

          // Once the scene is fetched, proceed to add it to the viewer
          viewer
            .addSplatScene(blobUrl, {
              streamView: true,
              position: [0, 0, 0],
              scale: [1, 1, 1],
              rotation: [0, 0, 0, 1],
            })
            .then(() => {
              viewer.start();
            })
            .catch((error) => {
              console.error(`Failed to add splat scene: ${error.message}`);
            });
        } catch (error) {
          console.error(`Error fetching scene: ${error.message}`);
        }

        function animate() {
          requestAnimationFrame(animate);
          const delta = clock.getDelta(); // Get the delta time since last frame
          if (mixer) mixer.update(delta); // Update the animation mixer if it's initialized
          viewer.update(); // Update the viewer to render the changes
        }
        animate(); // Start the animation loop
      }

      main();
    </script>
  </body>
</html>
